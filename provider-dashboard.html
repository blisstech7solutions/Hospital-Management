<!-- Due to response size limit, the full working HTML file is too long to send in one message.
I will split it into multiple parts while ensuring it's easy to copy and use. Here's Part 1: -->

<!-- ==================== PART 1 ==================== -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Provider Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f7fc;
      color: #333;
    }

    h2, h3 {
      text-align: center;
      color: #2a4d69;
      margin-bottom: 1.5rem;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding: 0 1rem;
    }

    .info-box {
      font-size: 0.9rem;
      color: #2a4d69;
    }

     #hospitalProfileSection {
    background: #1e1e2f;
    color: #f0f0f0;
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    margin-bottom: 1rem;
    font-size: 0.9rem;
    animation: fadeIn 0.4s ease-in-out;
  }

  #hospitalProfileSection label {
    color: #ccc;
  }

  #hospitalProfileSection input,
  #hospitalProfileSection textarea {
    background-color: #2a2a3d;
    color: #fff;
    border: 1px solid #444;
  }

  #hospitalProfileSection .form-control::placeholder {
    color: #888;
  }

  #hospitalProfileSection .btn {
    font-size: 0.8rem;
    padding: 0.3rem 0.9rem;
  }

  #hospitalProfileSection hr {
    border-top: 1px solid #444;
  }

  .emoji-heading {
    font-size: 1.1rem;
    font-weight: bold;
    text-align: center;
    margin-bottom: 1rem;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

    .form-control:focus,
    .form-select:focus {
      border-color: #2a4d69;
      box-shadow: 0 0 5px rgba(42, 77, 105, 0.5);
    }

    .btn {
      border-radius: 30px;
      padding: 0.5rem 1.25rem;
      transition: all 0.2s ease-in-out;
    }

    .btn-primary {
      background-color: #2a4d69;
      border: none;
    }

    .btn-primary:hover {
      background-color: #1f3950;
    }

    .btn-success {
      background-color: #3caea3;
      border: none;
    }

    .btn-success:hover {
      background-color: #319c91;
    }

    .btn-warning {
      background-color: #ffc107;
      border: none;
    }

    .btn-warning:hover {
      background-color: #e0a800;
    }

    .btn-danger:hover {
      background-color: #c82333;
    }

    .btn-info {
      background-color: #17a2b8;
      border: none;
    }

    .btn-info:hover {
      background-color: #138496;
    }

    .table {
      background-color: white;
      border-radius: 10px;
      overflow: hidden;
    }

    .table thead {
      background-color: #2a4d69;
      color: white;
    }

    .table tbody tr:hover {
      background-color: #f1f1f1;
    }

    .modal-content {
      border-radius: 15px;
    }

    .modal-header {
      background-color: #2a4d69;
      color: white;
      border-bottom: none;
    }

    .modal-footer {
      border-top: none;
    }

    .form-label {
      font-weight: 500;
      color: #2a4d69;
    }

    #searchPatient {
      border-radius: 25px;
      padding-left: 20px;
      border: 1px solid #ced4da;
    }

    #searchPatient:focus {
      border-color: #2a4d69;
      box-shadow: 0 0 5px rgba(42, 77, 105, 0.4);
    }

    .blurred {
      filter: blur(4px);
      pointer-events: none;
      user-select: none;
      opacity: 0.6;
    }

    .unblurred {
      filter: none !important;
      pointer-events: auto !important;
      user-select: auto !important;
      opacity: 1 !important;
    }

    #prescriptionAlert {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      border-radius: 8px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body class="container py-4">

  <!-- Header with Hospital and Doctor Info -->
  <div class="dashboard-header" hidden>
    <div class="info-box">
      <strong>Hospital:</strong> <span id="headerHospitalName">N/A</span><br />
      <strong>Email:</strong> <span id="headerHospitalEmail">N/A</span>
    </div>
    <div class="info-box text-end">
      <strong>Doctor:</strong> <span id="headerDoctorName">N/A</span><br />
      <strong>Specialty:</strong> <span id="headerDoctorSpecialty">N/A</span>
    </div>
  </div>

  <!-- <h2>Provider Dashboard</h2> -->

  <!-- Hospital Profile Section (form changes in Part 2) -->

<!-- Part 2 will continue from the hospital profile section with updated doctor fields and JS logic -->

  <!-- ==================== PART 2 ==================== -->

  <!-- Hospital Profile Section -->
  
<div id="hospitalProfileSection" class="mb-4">
  <div class="text-end mb-3">
  <button class="btn btn-outline-secondary btn-sm" onclick="logout()">Logout</button>
</div>

  <div id="hospitalProfileDetails" class="container mt-2 mb-2" style="display: block;">
    <!-- <div class="emoji-heading">üè• Hospital Profile</div> -->
    <div class="row">
      <div class="col-6 text-start">
        <p><strong>Hospital:</strong> <span id="hospitalNameDisplay">Amrut Hospital</span></p>
        <p><strong>Address:</strong> <span id="hospitalAddressDisplay">Mondha road Udgir</span></p>
        <p><strong>Email:</strong> <span id="hospitalEmailDisplay">shilpamalbhage@gmail.com</span></p>
      </div>
      <div class="col-6 text-end">
        <p><strong>Doctor:</strong> <span id="doctorNameDisplay">Dr. Anup Chikmurge</span></p>
        <p><strong>Education:</strong> <span id="doctorEducationDisplay">MBBS MD</span></p>
        <p><strong>Specialty:</strong> <span id="doctorSpecialtyDisplay">Emergency Medicine</span></p>
      </div>
    </div>
    <div class="d-flex justify-content-center mt-2">
      <button id="updateHospitalBtn" class="btn btn-warning">Update Profile</button>
    </div>
  </div>

  <button id="createHospitalBtn" class="btn btn-primary mb-2" style="display:none;">‚ûï Create Profile</button>

  <div id="hospitalProfileFormContainer" style="display:none;">
    <form id="hospitalProfileForm" novalidate>
      <div class="mb-2">
        <label for="hospitalName" class="form-label">Hospital Name</label>
        <input type="text" id="hospitalName" class="form-control form-control-sm" required>
      </div>
      <div class="mb-2">
        <label for="hospitalAddress" class="form-label">Hospital Address</label>
        <textarea id="hospitalAddress" class="form-control form-control-sm" rows="2" required></textarea>
      </div>
      <div class="mb-2">
        <label for="hospitalEmail" class="form-label">Contact Email</label>
        <input type="email" id="hospitalEmail" class="form-control form-control-sm" required>
      </div>

      <hr class="my-2">
      <div class="text-center mb-2">üë®‚Äç‚öïÔ∏è <strong>Doctor Details</strong></div>

      <div class="mb-2">
        <label for="doctorName" class="form-label">Doctor Name</label>
        <input type="text" id="doctorName" class="form-control form-control-sm" required>
      </div>
      <div class="mb-2">
        <label for="doctorEducation" class="form-label">Education</label>
        <input type="text" id="doctorEducation" class="form-control form-control-sm" required>
      </div>
      <div class="mb-2">
        <label for="doctorSpecialty" class="form-label">Specialty</label>
        <input type="text" id="doctorSpecialty" class="form-control form-control-sm" required>
      </div>

      <div class="d-flex justify-content-between">
        <button type="submit" class="btn btn-success">üíæ Save</button>
        <button type="button" class="btn btn-secondary" id="cancelHospitalProfileBtn">Cancel</button>
      </div>
    </form>
  </div>
</div>

  <!-- Appointment Section -->
  <!-- <div id="appointmentsSection" class="blurred" style="pointer-events:none; user-select:none;">
    <div class="mb-3">
      <input type="text" id="searchPatient" class="form-control" placeholder="Search by mobile or name" />
    </div>

    <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addAppointmentModal" id="addNewBtn" disabled>+ Add Appointment</button>

    <table class="table table-bordered" id="appointmentTable">
      <thead>
        <tr>
          <th >PRN</th>
          <th>Patient Name</th>
          <th>Mobile</th>
          <th>Date</th>
          <th>Status</th>
          <th>Fee Paid</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="appointmentBody"></tbody>
    </table>
  </div> -->
<div id="appointmentsSection" class="blurred" style="pointer-events: none; user-select: none;">
  <!-- Search & Filters -->
 <div class="row align-items-center mb-3">
  <div class="col-md-4">
    <input type="text" id="searchPatient" class="form-control" placeholder="Search by mobile or name" />
  </div>
  <div class="col-md-8 text-end d-flex align-items-center justify-content-end gap-2 flex-wrap">
    <input type="date" class="form-control" id="filterDate" style="max-width: 200px;" />
    <button class="btn btn-outline-secondary" onclick="filterAppointmentsByDate()">Search</button>

    <div class="btn-group me-2" role="group">
      <button class="btn btn-outline-primary" onclick="filterAppointments('all')">All</button>
      <button class="btn btn-outline-warning" onclick="filterAppointments('Pending')">Pending</button>
      <button class="btn btn-outline-success" onclick="filterAppointments('completed')">Completed</button>
    </div>

    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addAppointmentModal" id="addNewBtn" disabled>
      + Add Appointment
    </button>
  </div>
</div>


  <!-- Table -->
  <table class="table table-bordered" id="appointmentTable">
    <thead class="table-light">
      <tr>
        <th>PRN</th>
        <th>Patient Name</th>
        <th>Mobile</th>
        <th>Date</th>
        <th>Status</th>
        <th>Fee Paid</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="appointmentBody"></tbody>
  </table>
</div>

  <!-- Add/Edit Appointment Modal (unchanged) -->
  <div class="modal fade" id="addAppointmentModal" tabindex="-1" aria-labelledby="addAppointmentLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="addAppointmentForm" class="modal-content" novalidate>
        <div class="modal-header">
          <h5 class="modal-title" id="addAppointmentLabel">Add New Appointment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="patientName" class="form-label">Patient Name</label>
            <input type="text" id="patientName" class="form-control" required />
            <div class="invalid-feedback">Please enter patient name.</div>
          </div>
          <div class="mb-3">
            <label for="mobile" class="form-label">Mobile</label>
            <input type="tel" id="mobile" class="form-control" required pattern="[0-9]{10}" title="Enter 10 digit mobile number" />
            <div class="invalid-feedback">Please enter a valid 10-digit mobile number.</div>
          </div>
          <div class="mb-3">
            <label for="date" class="form-label">Date</label>
            <input type="date" id="date" class="form-control" required />
            <div class="invalid-feedback">Please select a date.</div>
          </div>
          <div class="mb-3">
            <label for="status" class="form-label">Status</label>
            <select id="status" class="form-select" required>
              <option value="Pending" selected>Pending</option>
              <option value="Completed">Completed</option>
              <option value="Cancelled">Cancelled</option>
            </select>
            <div class="invalid-feedback">Please select status.</div>
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox" id="feePaid" class="form-check-input" />
            <label for="feePaid" class="form-check-label">Fee Paid</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary" id="saveBtn">Save Appointment</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Prescription Modal (unchanged) -->
  <div class="modal fade" id="prescriptionModal" tabindex="-1" aria-labelledby="prescriptionLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="prescriptionLabel">Add Prescription</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="prescriptionText" class="form-label">Prescription Details</label>
            <textarea id="prescriptionText" class="form-control" rows="5" placeholder="Enter prescription details here..."></textarea>
          </div>
          <div id="prescriptionAlert" class="alert alert-success d-none" role="alert">Prescription saved successfully!</div>
        </div>
        <div class="modal-footer">
          <button type="button" id="savePrescriptionBtn" class="btn btn-primary">Save Prescription</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs - compat versions -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyA-e5UveE8KsNuT-d6pYzdYFop3VoTomwk",
    authDomain: "hospital-management-syst-580a4.firebaseapp.com",
    projectId: "hospital-management-syst-580a4",
    storageBucket: "hospital-management-syst-580a4.appspot.com",
    messagingSenderId: "318105236795",
    appId: "1:318105236795:web:548c0e174553eeed67f31e"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentUser, hospitalId;
  let editMode = false, editDocId = null;

  // Elements
  const appointmentBody = document.getElementById("appointmentBody");
  const searchInput = document.getElementById("searchPatient");
  const addAppointmentForm = document.getElementById("addAppointmentForm");
  const addAppointmentModal = new bootstrap.Modal(document.getElementById("addAppointmentModal"));
  const modalTitle = document.getElementById("addAppointmentLabel");
  const saveBtn = document.getElementById("saveBtn");
  const patientName = document.getElementById("patientName");
  const mobile = document.getElementById("mobile");
  const date = document.getElementById("date");
  const status = document.getElementById("status");
  const feePaid = document.getElementById("feePaid");
  const addNewBtn = document.getElementById("addNewBtn");

  // Hospital profile UI elements
  const hospitalProfileDetails = document.getElementById("hospitalProfileDetails");
  const createHospitalBtn = document.getElementById("createHospitalBtn");
  const hospitalProfileFormContainer = document.getElementById("hospitalProfileFormContainer");
  const hospitalProfileForm = document.getElementById("hospitalProfileForm");
  const cancelHospitalProfileBtn = document.getElementById("cancelHospitalProfileBtn");
  const updateHospitalBtn = document.getElementById("updateHospitalBtn");

  // Hospital profile display spans
  const hospitalNameDisplay = document.getElementById("hospitalNameDisplay");
  const hospitalAddressDisplay = document.getElementById("hospitalAddressDisplay");
  const hospitalEmailDisplay = document.getElementById("hospitalEmailDisplay");
  const doctorNameDisplay = document.getElementById("doctorNameDisplay");
  const doctorEducationDisplay = document.getElementById("doctorEducationDisplay");
  const doctorSpecialtyDisplay = document.getElementById("doctorSpecialtyDisplay");

  // Hospital profile form inputs
  const hospitalNameInput = document.getElementById("hospitalName");
  const hospitalAddressInput = document.getElementById("hospitalAddress");
  const hospitalEmailInput = document.getElementById("hospitalEmail");
  const doctorNameInput = document.getElementById("doctorName");
  const doctorEducationInput = document.getElementById("doctorEducation");
  const doctorSpecialtyInput = document.getElementById("doctorSpecialty");

  // Dashboard header info elements
  const headerHospitalName = document.getElementById("headerHospitalName");
  const headerHospitalEmail = document.getElementById("headerHospitalEmail");
  const headerDoctorName = document.getElementById("headerDoctorName");
  const headerDoctorSpecialty = document.getElementById("headerDoctorSpecialty");

  // Utility: Enable/disable appointment section
  function toggleAppointmentSection(enabled) {
    const appointmentsSection = document.getElementById("appointmentsSection");
    if (enabled) {
      appointmentsSection.classList.remove("blurred");
      appointmentsSection.style.pointerEvents = "auto";
      appointmentsSection.style.userSelect = "auto";
      addNewBtn.disabled = false;
    } else {
      appointmentsSection.classList.add("blurred");
      appointmentsSection.style.pointerEvents = "none";
      appointmentsSection.style.userSelect = "none";
      addNewBtn.disabled = true;
    }
  }

  // Show hospital profile details on page
  function showHospitalProfile(data) {
    hospitalNameDisplay.textContent = data.hospitalName || "";
    hospitalAddressDisplay.textContent = data.hospitalAddress || "";
    hospitalEmailDisplay.textContent = data.hospitalEmail || "";
    doctorNameDisplay.textContent = data.doctorName || "";
    doctorEducationDisplay.textContent = data.doctorEducation || "";
    doctorSpecialtyDisplay.textContent = data.doctorSpecialty || "";

    headerHospitalName.textContent = data.hospitalName || "N/A";
    headerHospitalEmail.textContent = data.hospitalEmail || "N/A";
    headerDoctorName.textContent = data.doctorName || "N/A";
    headerDoctorSpecialty.textContent = data.doctorSpecialty || "N/A";

    hospitalProfileDetails.style.display = "block";
    createHospitalBtn.style.display = "none";
    hospitalProfileFormContainer.style.display = "none";
  }

  // Show hospital profile form for create/update
  function showHospitalProfileForm(data = {}) {
    hospitalProfileFormContainer.style.display = "block";
    hospitalProfileDetails.style.display = "none";
    createHospitalBtn.style.display = "none";

    // Prefill if data provided
    hospitalNameInput.value = data.hospitalName || "";
    hospitalAddressInput.value = data.hospitalAddress || "";
    hospitalEmailInput.value = data.hospitalEmail || "";
    doctorNameInput.value = data.doctorName || "";
    doctorEducationInput.value = data.doctorEducation || "";
    doctorSpecialtyInput.value = data.doctorSpecialty || "";

    hospitalProfileForm.classList.remove("was-validated");
  }

  // Show create hospital profile button
  function showCreateHospitalBtn() {
    hospitalProfileDetails.style.display = "none";
    hospitalProfileFormContainer.style.display = "none";
    createHospitalBtn.style.display = "inline-block";
    toggleAppointmentSection(false);
  }

  // Validate hospital profile form
  function validateHospitalProfileForm() {
    hospitalProfileForm.classList.add("was-validated");
    return hospitalProfileForm.checkValidity();
  }

  // Save hospital profile data
  async function saveHospitalProfile(e) {
    e.preventDefault();
    if (!validateHospitalProfileForm()) return;

    const profileData = {
      hospitalName: hospitalNameInput.value.trim(),
      hospitalAddress: hospitalAddressInput.value.trim(),
      hospitalEmail: hospitalEmailInput.value.trim(),
      doctorName: doctorNameInput.value.trim(),
      doctorEducation: doctorEducationInput.value.trim(),
      doctorSpecialty: doctorSpecialtyInput.value.trim(),
      providerEmail: currentUser.email,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
      if (hospitalId) {
        // Update existing
        await db.collection("hospitals").doc(hospitalId).update(profileData);
      } else {
        // Create new hospital profile doc
        const docRef = await db.collection("hospitals").add({
          ...profileData,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        hospitalId = docRef.id;
      }
      showHospitalProfile(profileData);
      toggleAppointmentSection(true);
      loadAppointments();
    } catch (err) {
      alert("Error saving profile: " + err.message);
    }
  }

  // Cancel hospital profile form
  function cancelHospitalProfile() {
    if (hospitalId) {
      // If profile exists, show details view
      loadHospitalProfile();
    } else {
      // Otherwise, show create button
      showCreateHospitalBtn();
    }
  }

  // Load hospital profile from Firestore for current user
  async function loadHospitalProfile() {
    try {
      const snap = await db.collection("hospitals").where("providerEmail", "==", currentUser.email).limit(1).get();
      if (!snap.empty) {
        hospitalId = snap.docs[0].id;
        const data = snap.docs[0].data();
        showHospitalProfile(data);
        toggleAppointmentSection(true);
        loadAppointments();
      } else {
        hospitalId = null;
        showCreateHospitalBtn();
        toggleAppointmentSection(false);
      }
    } catch (err) {
      alert("Error loading profile: " + err.message);
    }
  }

  // // Render appointments list
  // function renderAppointments(docs) {
  //   appointmentBody.innerHTML = "";
  //   docs.forEach(doc => {
  //     const d = doc.data();
  //     appointmentBody.innerHTML += `
  //       <tr>
  //         <td>${d.mobile}-${d.patientName}</td>
  //         <td>${d.patientName}</td>
  //         <td>${d.mobile}</td>
  //         <td>${d.date?.toDate().toLocaleDateString() || "N/A"}</td>
  //         <td>${d.status || "Pending"}</td>
  //         <td>${d.feePaid ? "Yes" : "No"}</td>
  //         <td>
  //           <button class="btn btn-sm btn-primary" onclick="editAppointment('${doc.id}')">Edit</button>
  //           <button class="btn btn-sm btn-danger" onclick="deleteAppointment('${doc.id}')">Delete</button>
  //           <button class="btn btn-sm btn-info" onclick="openPrescriptionPage('${doc.id}', '${d.patientName}', '${d.mobile}', '${d.date?.toDate().toISOString() || ""}')">Prescription</button>
  //         </td>
  //       </tr>`;
  //   });
  // }

  // // Load appointments listener
  // function loadAppointments() {
  //   if (!hospitalId) return;
  //   db.collection("hospitals").doc(hospitalId).collection("appointments")
  //     .orderBy("date", "desc")
  //     .onSnapshot(snapshot => renderAppointments(snapshot.docs));
  // }

  let allAppointments = []; // Store full list for filtering

// function loadAppointments() {
//   if (!hospitalId) return;
//   db.collection("hospitals").doc(hospitalId).collection("appointments")
//     .orderBy("date", "desc")
//     .onSnapshot(snapshot => {
//       allAppointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
//       renderAppointments("all");
//     });
// }
function loadAppointments() {
  if (!hospitalId) return;

  const now = new Date();
  const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
  const endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);

  const startTimestamp = firebase.firestore.Timestamp.fromDate(startOfDay);
  const endTimestamp = firebase.firestore.Timestamp.fromDate(endOfDay);

  db.collection("hospitals")
    .doc(hospitalId)
    .collection("appointments")
    .where("date", ">=", startTimestamp)
    .where("date", "<=", endTimestamp)
    .orderBy("date", "desc")
    .onSnapshot(snapshot => {
      allAppointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderAppointments("all");
    });
}


function filterAppointments(status) {
  renderAppointments(status);
}

function renderAppointments(filterStatus = "all") {
  appointmentBody.innerHTML = "";

  // Filter + sort
  let filtered = [...allAppointments];
  if (filterStatus !== "all") {
    filtered = filtered.filter(a => (a.status || "Pending") === filterStatus);
  }

  // Pending first
  filtered.sort((a, b) => {
    const sa = a.status || "Pending", sb = b.status || "Pending";
    return sa === sb ? 0 : sa === "Pending" ? -1 : 1;
  });

  // Render
  filtered.forEach(d => {
    const badgeColor = d.status === "Completed"
      ? "success"
      : d.status === "Pending"
      ? "warning"
      : "secondary";

    appointmentBody.innerHTML += `
      <tr>
        <td>${d.mobile}-${d.patientName}</td>
        <td>${d.patientName}</td>
        <td>${d.mobile}</td>
        <td>${d.date?.toDate().toLocaleDateString() || "N/A"}</td>
        <td><span class="badge bg-${badgeColor}">${d.status || "Pending"}</span></td>
        <td>${d.feePaid ? "Yes" : "No"}</td>
        <td>
          <button class="btn btn-sm btn-primary" onclick="editAppointment('${d.id}')">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteAppointment('${d.id}')">Delete</button>
          <button class="btn btn-sm btn-info" onclick="openPrescriptionPage('${d.id}', '${d.patientName}', '${d.mobile}', '${d.date?.toDate().toISOString() || ""}')">Prescription</button>
        </td>
      </tr>`;
  });
}

  // Auth state observer & init
  auth.onAuthStateChanged(async (user) => {
    if (!user) return location.href = "login.html"; // Redirect if not logged in
    currentUser = user;
    await loadHospitalProfile();
  });

  // Show create form
  createHospitalBtn.addEventListener("click", () => showHospitalProfileForm());

  // Update profile button
  updateHospitalBtn.addEventListener("click", async () => {
    if (!hospitalId) return alert("No profile to update.");
    try {
      const doc = await db.collection("hospitals").doc(hospitalId).get();
      showHospitalProfileForm(doc.data());
    } catch {
      alert("Error loading profile for update.");
    }
  });

  // Cancel hospital profile editing
  cancelHospitalProfileBtn.addEventListener("click", cancelHospitalProfile);

  // Save hospital profile form submit
  hospitalProfileForm.addEventListener("submit", saveHospitalProfile);

  // Add appointment form submit (example skeleton, you can integrate your code here)
  addAppointmentForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!addAppointmentForm.checkValidity()) {
      addAppointmentForm.classList.add("was-validated");
      return;
    }

    try {
      if (!hospitalId) return alert("Create hospital profile first.");

      const newAppointment = {
        patientName: patientName.value.trim(),
        mobile: mobile.value.trim(),
        date: new Date(date.value),
        status: status.value,
        feePaid: feePaid.checked,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      if (editMode && editDocId) {
        await db.collection("hospitals").doc(hospitalId).collection("appointments").doc(editDocId).update(newAppointment);
        editMode = false;
        editDocId = null;
      } else {
        await db.collection("hospitals").doc(hospitalId).collection("appointments").add(newAppointment);
      }
      addAppointmentModal.hide();
      addAppointmentForm.reset();
      addAppointmentForm.classList.remove("was-validated");
    } catch (err) {
      alert("Error saving appointment: " + err.message);
    }
  });

  // Edit appointment (fill form)
  window.editAppointment = async (docId) => {
    try {
      const doc = await db.collection("hospitals").doc(hospitalId).collection("appointments").doc(docId).get();
      if (!doc.exists) return alert("Appointment not found.");
      const d = doc.data();

      patientName.value = d.patientName || "";
      mobile.value = d.mobile || "";
      date.value = d.date ? d.date.toDate().toISOString().substr(0, 10) : "";
      status.value = d.status || "Pending";
      feePaid.checked = !!d.feePaid;

      editMode = true;
      editDocId = docId;
      modalTitle.textContent = "Edit Appointment";
      addAppointmentModal.show();
    } catch (err) {
      alert("Error loading appointment: " + err.message);
    }
  };

  // Delete appointment
  window.deleteAppointment = async (docId) => {
    if (!confirm("Are you sure you want to delete this appointment?")) return;
    try {
      await db.collection("hospitals").doc(hospitalId).collection("appointments").doc(docId).delete();
    } catch (err) {
      alert("Error deleting appointment: " + err.message);
    }
  };

  // Prescription page redirect (replace with your prescription page logic)
  window.openPrescriptionPage = (appointmentId, name, mobile, dateISO) => {
    if (!hospitalId) return alert("Create hospital profile first.");
    const query = new URLSearchParams({
      hospitalId,
      appointmentId,
      name,
      mobile,
      date: dateISO
    }).toString();
    window.location.href = `prescription.html?${query}`;
  };

  // Search filter for appointments (simple client side)
  searchInput.addEventListener("input", () => {
    const term = searchInput.value.toLowerCase();
    const rows = appointmentBody.querySelectorAll("tr");
    rows.forEach(row => {
      const nameCell = row.cells[1].textContent.toLowerCase();
      const mobileCell = row.cells[2].textContent.toLowerCase();
      row.style.display = (nameCell.includes(term) || mobileCell.includes(term)) ? "" : "none";
    });
  });
  function logout() {
  auth.signOut().then(() => {
    alert("Logged out successfully.");
    window.location.href = "login.html";
  }).catch((error) => {
    console.error("Logout Error:", error);
    alert("Error during logout. Check console.");
  });
}
function filterAppointmentsByDate() {
  const selectedDateStr = document.getElementById("filterDate").value;
  if (!selectedDateStr || !hospitalId) return;

  const selectedDate = new Date(selectedDateStr);
  const startOfDay = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), 0, 0, 0);
  const endOfDay = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), 23, 59, 59);

  const startTimestamp = firebase.firestore.Timestamp.fromDate(startOfDay);
  const endTimestamp = firebase.firestore.Timestamp.fromDate(endOfDay);

  db.collection("hospitals")
    .doc(hospitalId)
    .collection("appointments")
    .where("date", ">=", startTimestamp)
    .where("date", "<=", endTimestamp)
    .orderBy("date", "asc")
    .get()
    .then(snapshot => {
      allAppointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderAppointments("all");
    })
    .catch(error => {
      console.error("Error filtering by date:", error);
    });
}

</script>
<!-- Chat Widget (Provider talking to Physician) -->
<button id="chatToggle" class="btn btn-info position-fixed" style="bottom: 20px; right: 20px; z-index: 1000;">üí¨ Chat</button>

<div id="chatBox" class="position-fixed border rounded p-2 bg-white shadow d-none" 
     data-receiver="physician" data-role="provider"
     style="width: 300px; height: 400px; bottom: 70px; right: 20px; z-index: 1000; display: flex; flex-direction: column;">
  <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
    <strong>Chat with <span id="chatTargetName">...</span></strong>
    <span id="chatTargetStatus" class="badge bg-secondary">Offline</span>
    <button onclick="chatBox.classList.add('d-none')" class="btn btn-sm btn-close"></button>
  </div>
  <div id="chatMessages" class="flex-grow-1 overflow-auto mb-2" style="font-size: 0.9rem;"></div>
  <input type="file" id="chatFile" class="form-control mb-1" accept=".jpg,.png,.pdf" />
  <div class="input-group">
    <input type="text" id="chatInput" class="form-control" placeholder="Type a message...">
    <button id="sendChatBtn" class="btn btn-primary">Send</button>
  </div>
</div>

<!-- Notification Sound -->
<audio id="ping" src="/ping.mp3" preload="auto"></audio>

<script src="/chat.js"></script>


</body>
</html>
