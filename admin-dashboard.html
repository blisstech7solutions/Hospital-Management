<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Hospital Control</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .status-badge { font-size: 0.9em; }
    .approved { color: green; font-weight: bold; }
    .pending { color: orange; font-weight: bold; }
    .rejected { color: red; font-weight: bold; }
  </style>
</head>
<body class="container py-4">
  <h2 class="mb-4 text-center">üè• Admin - Hospital & User Control Dashboard</h2>

  <!-- DASHBOARD TABS -->
  <ul class="nav nav-tabs mb-4" id="dashboardTabs">
    <li class="nav-item">
      <a class="nav-link active" href="#" onclick="showSection('hospitals')">Hospitals</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#" onclick="showSection('users')">Users</a>
    </li>
  </ul>

  <!-- SECTION: HOSPITALS -->
  <div id="hospitalsSection">
    <div class="row mb-4 text-center">
      <div class="col"><div class="border rounded p-3 bg-light"><h5>Total</h5><div id="totalCount">0</div></div></div>
      <div class="col"><div class="border rounded p-3 bg-light"><h5>Approved</h5><div id="approvedCount">0</div></div></div>
      <div class="col"><div class="border rounded p-3 bg-light"><h5>Pending</h5><div id="pendingCount">0</div></div></div>
      <div class="col"><div class="border rounded p-3 bg-light"><h5>Rejected</h5><div id="rejectedCount">0</div></div></div>
    </div>

    <div class="mb-3 text-center">
      <button class="btn btn-outline-primary me-2" onclick="loadHospitals('all')">All</button>
      <button class="btn btn-outline-success me-2" onclick="loadHospitals('approved')">Approved</button>
      <button class="btn btn-outline-warning me-2" onclick="loadHospitals('pending')">Pending</button>
      <button class="btn btn-outline-danger me-2" onclick="loadHospitals('rejected')">Rejected</button>
    </div>

    <div id="hospitalList" class="border rounded p-3 bg-light"></div>
  </div>

  <!-- SECTION: USERS -->
  <div id="usersSection" style="display: none;">
    <div class="row mb-4 text-center">
      <div class="col"><div class="border rounded p-3 bg-light"><h5>Total Users</h5><div id="totalUsers">0</div></div></div>
      <div class="col"><div class="border rounded p-3 bg-light"><h5>Approved</h5><div id="approvedUsers">0</div></div></div>
      <div class="col"><div class="border rounded p-3 bg-light"><h5>Pending</h5><div id="pendingUsers">0</div></div></div>
    </div>

    <div class="mb-3 text-center">
      <button class="btn btn-outline-primary me-2" onclick="loadUsers('all')">All</button>
      <button class="btn btn-outline-success me-2" onclick="loadUsers('approved')">Approved</button>
      <button class="btn btn-outline-warning me-2" onclick="loadUsers('pending')">Pending</button>
      <button class="btn btn-outline-info me-2" onclick="loadUsers('provider')">Providers</button>
      <button class="btn btn-outline-dark me-2" onclick="loadUsers('physician')">Physicians</button>
    </div>

    <div id="userList" class="border rounded p-3 bg-light"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA-e5UveE8KsNuT-d6pYzdYFop3VoTomwk",
      authDomain: "hospital-management-syst-580a4.firebaseapp.com",
      projectId: "hospital-management-syst-580a4",
      storageBucket: "hospital-management-syst-580a4.appspot.com",
      messagingSenderId: "318105236795",
      appId: "1:318105236795:web:548c0e174553eeed67f31e"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const auth = firebase.auth();
    const db = firebase.firestore();
    const adminEmail = "vaibhavmalbhage@gmail.com";

    auth.onAuthStateChanged(async (user) => {
      if (!user || user.email !== adminEmail) {
        alert("Unauthorized access");
        window.location.href = "login.html";
        return;
      }
      loadDashboardCounts();
      loadHospitals('all');
      loadUsers('all');
    });

    function showSection(section) {
      document.getElementById("hospitalsSection").style.display = section === 'hospitals' ? 'block' : 'none';
      document.getElementById("usersSection").style.display = section === 'users' ? 'block' : 'none';
      const tabs = document.querySelectorAll('#dashboardTabs .nav-link');
      tabs.forEach(tab => tab.classList.remove('active'));
      document.querySelector(`#dashboardTabs .nav-link[href="#"][onclick*="${section}"]`).classList.add('active');
    }

    async function loadDashboardCounts() {
      const snap = await db.collection("hospitals").get();
      let total = 0, approved = 0, pending = 0, rejected = 0;

      snap.forEach(doc => {
        const h = doc.data();
        total++;
        if (h.status === 'approved') approved++;
        else if (h.status === 'pending') pending++;
        else if (h.status === 'rejected') rejected++;
      });

      document.getElementById("totalCount").innerText = total;
      document.getElementById("approvedCount").innerText = approved;
      document.getElementById("pendingCount").innerText = pending;
      document.getElementById("rejectedCount").innerText = rejected;
    }

    async function loadHospitals(filterStatus) {
      let query = db.collection("hospitals");
      if (filterStatus !== 'all') {
        query = query.where("status", "==", filterStatus);
      }
      const snap = await query.orderBy("createdAt", "desc").get();
      let html = "";

      snap.forEach(doc => {
        const h = doc.data();
        html += `
          <div class="mb-3 border-bottom pb-2">
            <h5>${h.hospitalName || h.name}</h5>
            <p class="mb-1">${h.hospitalAddress || h.address}</p>
            <p class="mb-1"><strong>Doctor:</strong> ${h.doctorName || 'N/A'} (${h.doctorSpecialty || 'N/A'})</p>
            <p class="mb-1"><strong>Education:</strong> ${h.doctorEducation || 'N/A'}</p>
            <small>
              Hospital Email: ${h.hospitalEmail || 'N/A'}<br>
              Provider Email: ${h.providerEmail || h.createdBy || 'N/A'}<br>
              Partner Email: ${h.partnerEmail || 'N/A'}<br>
              Created: ${h.createdAt?.toDate().toLocaleString() || 'N/A'}<br>
              Updated: ${h.updatedAt?.toDate().toLocaleString() || 'N/A'}
            </small><br>
            <span class="status-badge ${h.status}">Status: ${h.status}</span><br>
            ${h.status === 'pending' ? `
              <button class="btn btn-sm btn-success me-2" onclick="approveHospital('${doc.id}')">Approve</button>
              <button class="btn btn-sm btn-danger me-2" onclick="rejectHospital('${doc.id}')">Reject</button>
            ` : ''}
            <button class="btn btn-sm btn-outline-danger" onclick="deleteHospital('${doc.id}')">Delete</button>
          </div>
        `;
      });

      document.getElementById("hospitalList").innerHTML = html || "<i>No hospitals found for this filter.</i>";
    }

    async function approveHospital(id) {
      await db.collection("hospitals").doc(id).update({ status: "approved" });
      loadDashboardCounts();
      loadHospitals('pending');
    }

    async function rejectHospital(id) {
      await db.collection("hospitals").doc(id).update({ status: "rejected" });
      loadDashboardCounts();
      loadHospitals('pending');
    }

    async function deleteHospital(id) {
      if (confirm("Are you sure you want to delete this hospital?")) {
        await db.collection("hospitals").doc(id).delete();
        loadDashboardCounts();
        loadHospitals('all');
      }
    }

    async function loadUsers(filter) {
      let query = db.collection("users");
      if (filter === 'approved') query = query.where("isApproved", "==", true);
      else if (filter === 'pending') query = query.where("isApproved", "==", false);
      else if (filter === 'provider' || filter === 'physician') query = query.where("role", "==", filter);

      const snap = await query.get();
      let html = "";
      let total = 0, approved = 0, pending = 0;

      snap.forEach(doc => {
        const u = doc.data();
        total++;
        if (u.isApproved) approved++;
        else pending++;

        html += `
          <div class="mb-3 border-bottom pb-2">
            <h5>${u.role.toUpperCase()} - ${u.email}</h5>
            <p><small>Appointments Email: ${u.appointmentsEmail || 'N/A'}</small></p>
            ${u.role === 'physician' ? `<p><small>Linked Provider: ${u.linkedProviderEmail || 'N/A'}</small></p>` : ""}
            <span class="status-badge ${u.isApproved ? 'approved' : 'pending'}">
              Status: ${u.isApproved ? 'Approved' : 'Pending'}
            </span><br>
            ${u.isApproved === false ? `
              <button class="btn btn-sm btn-success me-2" onclick="approveUser('${doc.id}')">Approve</button>
            ` : ''}
            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${doc.id}')">Delete</button>
          </div>
        `;
      });

      document.getElementById("userList").innerHTML = html || "<i>No users found.</i>";
      document.getElementById("totalUsers").innerText = total;
      document.getElementById("approvedUsers").innerText = approved;
      document.getElementById("pendingUsers").innerText = pending;
    }

    async function approveUser(userId) {
      await db.collection("users").doc(userId).update({ isApproved: true });
      loadUsers('all');
    }

    async function deleteUser(userId) {
      if (confirm("Are you sure you want to delete this user?")) {
        await db.collection("users").doc(userId).delete();
        loadUsers('all');
      }
    }
  </script>
</body>
</html>
